{% extends "base.html" %}

{% block title %}
  {{ plant["common_name"] }}{% if plant["variety_name"] %} – {{ plant["variety_name"] }}{% endif %}
  ({{ plant["label"] or ("#" ~ plant["id"]) }}) – Jardin de Devey
{% endblock %}

{% block content %}

<div class="d-flex gap-2 mb-3 flex-wrap">
  <a href="{{ url_for('plants') }}" class="btn btn-sm btn-outline">
    ← Retour aux plantes
  </a>

  <a href="{{ url_for('plant_edit', plant_id=plant['id']) }}"
     class="btn btn-sm btn-primary">
    Modifier cet individu
  </a>

  {% if plant["species_latin_name"] %}
    <a href="{{ url_for('species_detail', latin_name=plant['species_latin_name']) }}"
       class="btn btn-sm btn-outline-secondary ms-auto">
      Voir la fiche espèce ({{ plant["species_latin_name"] }})
    </a>
  {% endif %}
</div>


<div class="card shadow-soft mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-stretch">

      {# --- Colonne image --- #}
      <div class="col-12 col-md-4">
        {% set img_src = None %}
        {% if plant["image_local"] %}
          {% set img_src = url_for('static', filename=plant["image_local"]) %}
        {% elif plant["species_image_url"] %}
          {% set img_src = plant["species_image_url"] %}
        {% endif %}

        {% if img_src %}
          <div class="ratio ratio-4x3 mb-2">
            <img src="{{ img_src }}"
                 alt="Illustration de {{ plant['common_name'] }}"
                 class="img-fluid rounded-3"
                 style="object-fit: cover; object-position: center;">
          </div>
        {% else %}
          <div class="ratio ratio-4x3 mb-2 border rounded-3 d-flex align-items-center justify-content-center text-muted">
            <span class="small">Aucune image</span>
          </div>
        {% endif %}
      </div>

      {# --- TEXTE À DROITE : noms, taxonomie, hauteur, longévité, tags --- #}
      <div class="col-12 col-md-8 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h1 class="h4 mb-1">
              {{ plant["common_name"] }}
              {% if plant["variety_name"] %} – {{ plant["variety_name"] }}{% endif %}
            </h1>
            {% if plant["species_latin_name"] %}
              <p class="latin mb-2">
                <em>{{ plant["species_latin_name"] }}</em>
              </p>
            {% endif %}
          </div>
          <span class="badge bg-outline fs-6">
            {{ plant["label"] or ("#" ~ plant["id"]) }}
          </span>
        </div>

        <div class="row small mb-3">
          <div class="col-sm-6">
            <dl class="row mb-0">
              <dt class="col-4">Famille</dt>
              <dd class="col-8">{{ plant["species_family"] or "—" }}</dd>

              <dt class="col-4">Genre</dt>
              <dd class="col-8">{{ plant["species_genus"] or "—" }}</dd>

              <dt class="col-4">Strate</dt>
              <dd class="col-8">{{ plant["species_strata"] or "—" }}</dd>

              <dt class="col-4">Origine</dt>
              <dd class="col-8">{{ plant["species_origin"] or "—" }}</dd>

              <dt class="col-4">Type</dt>
              <dd class="col-8">{{ plant["species_plant_type"] or "—" }}</dd>

              {% if plant["species_height_min"] is not none or plant["species_height_max"] is not none %}
                <dt class="col-4">H. adulte</dt>
                <dd class="col-8">
                  {% if plant["species_height_min"] is not none %}
                    {{ plant["species_height_min"] }} m
                  {% endif %}
                  {% if plant["species_height_max"] is not none %}
                    – {{ plant["species_height_max"] }} m
                  {% endif %}
                </dd>
              {% endif %}

              {% if plant["species_lifespan_min"] is not none or plant["species_lifespan_max"] is not none %}
                <dt class="col-4">Longévité</dt>
                <dd class="col-8">
                  {% if plant["species_lifespan_min"] is not none %}
                    {{ plant["species_lifespan_min"] }} ans
                  {% endif %}
                  {% if plant["species_lifespan_max"] is not none %}
                    – {{ plant["species_lifespan_max"] }} ans
                  {% endif %}
                </dd>
              {% endif %}
            </dl>
          </div>

          <div class="col-sm-6">
            {% set s_tags = (plant["species_tags"] or "").split(",") %}
            {% if s_tags|selectattr('strip')|list %}
              <div class="mb-1 fw-semibold">Tags espèce / cultivar</div>
              <p class="mb-2">
                {% for t in s_tags %}
                  {% if t.strip() %}
                    <span class="badge bg-tag me-1 mb-1">{{ t.strip() }}</span>
                  {% endif %}
                {% endfor %}
              </p>
            {% endif %}

            {% if plant["species_melliferous_level"] or plant["species_ornamental_interest"] %}
              <div class="text-muted small">
                {% if plant["species_melliferous_level"] %}
                  Mellifère : {{ plant["species_melliferous_level"] }}
                  {% if plant["species_ornamental_interest"] %} · {% endif %}
                {% endif %}
                {% if plant["species_ornamental_interest"] %}
                  Intérêt ornemental : {{ plant["species_ornamental_interest"] }}
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        {# --- Notes combinées : espèce + cultivar + individu --- #}
        {% set chunks = [] %}

        {% if plant["species_notes"] %}
          {% set _ = chunks.append("Espèce : " ~ plant["species_notes"]) %}
        {% endif %}

        {% if plant["variety_notes"] %}
          {% set _ = chunks.append("Cultivar : " ~ plant["variety_notes"]) %}
        {% endif %}

        {% if plant["plant_notes"] %}
          {% set _ = chunks.append("Individu : " ~ plant["plant_notes"]) %}
        {% endif %}

        {% if chunks %}
          <div class="mt-2 small text-muted">
            {% for c in chunks %}
              <p class="mb-1">{{ c }}</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# ---------------------------------------------------------
   BLOC "Données de l’individu"
---------------------------------------------------------- #}

<h2 class="h6 mb-2">Données de l’individu</h2>

<div class="card shadow-soft mb-3">
  <div class="card-body small">
    <div class="row g-3">
      <div class="col-md-6">
        <dl class="row mb-0">
          <dt class="col-5 col-sm-4">Zone</dt>
          <dd class="col-7 col-sm-8">{{ plant["zone"] or "—" }}</dd>

          <dt class="col-5 col-sm-4">Planté le</dt>
          <dd class="col-7 col-sm-8">{{ plant["planted_at"] or "—" }}</dd>

          <dt class="col-5 col-sm-4">Latitude</dt>
          <dd class="col-7 col-sm-8">
            {{ plant["lat"] if plant["lat"] is not none else "—" }}
          </dd>

          <dt class="col-5 col-sm-4">Longitude</dt>
          <dd class="col-7 col-sm-8">
            {{ plant["lon"] if plant["lon"] is not none else "—" }}
          </dd>

          <dt class="col-5 col-sm-4">Altitude</dt>
          <dd class="col-7 col-sm-8">
            {% if plant["altitude"] is not none %}
              {{ plant["altitude"] }} m
            {% else %}
              —
            {% endif %}
          </dd>

          {% if plant["height_current"] is not none %}
            <dt class="col-5 col-sm-4">Hauteur actuelle</dt>
            <dd class="col-7 col-sm-8">{{ plant["height_current"] }} m</dd>
          {% endif %}

          {% if plant["status"] %}
            <dt class="col-5 col-sm-4">Statut</dt>
            <dd class="col-7 col-sm-8">{{ plant["status"] }}</dd>
          {% endif %}
        </dl>
      </div>

      <div class="col-md-6">
        {% if plant["tags"] %}
          <div class="mb-2">
            <div class="fw-semibold mb-1">Tags individu</div>
            {% for t in (plant["tags"] or "").split(",") %}
              {% if t.strip() %}
                <span class="badge bg-tag me-1 mb-1">{{ t.strip() }}</span>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if plant["micro_site"] or plant["exposure_local"] or plant["soil_local"] %}
          <div class="mb-2">
            <div class="fw-semibold mb-1">Contexte local</div>
            {% if plant["micro_site"] %}
              <div>Micro-site : {{ plant["micro_site"] }}</div>
            {% endif %}
            {% if plant["exposure_local"] %}
              <div>Exposition : {{ plant["exposure_local"] }}</div>
            {% endif %}
            {% if plant["soil_local"] %}
              <div>Sol : {{ plant["soil_local"] }}</div>
            {% endif %}
          </div>
        {% endif %}

        {% if plant["acquisition_type"] or plant["acquisition_source"] %}
          <div class="mb-2">
            <div class="fw-semibold mb-1">Origine de l’individu</div>
            <div>
              {% if plant["acquisition_type"] %}
                Type : {{ plant["acquisition_type"] }}
              {% endif %}
              {% if plant["acquisition_source"] %}
                <br>Source : {{ plant["acquisition_source"] }}
              {% endif %}
            </div>
          </div>
        {% endif %}

        {% if plant["rootstock"] %}
          <div class="mb-2">
            <div class="fw-semibold mb-1">Porte-greffe</div>
            <div>{{ plant["rootstock"] }}</div>
          </div>
        {% endif %}

        {% if plant["plantnet_obs_id"] %}
          <div class="mb-2">
            <div class="fw-semibold mb-1">Référence PlantNet</div>
            <div>Observation n° {{ plant["plantnet_obs_id"] }}</div>
          </div>
        {% endif %}
      </div>
    </div>

    {% if plant["notes"] or plant["care_notes"] %}
      <hr class="my-3">
      <div class="row small">
        <div class="col-md-6">
          {% if plant["notes"] %}
            <h3 class="h6">Notes d’observation</h3>
            <p class="mb-2">{{ plant["notes"] }}</p>
          {% endif %}
        </div>
        <div class="col-md-6">
          {% if plant["care_notes"] %}
            <h3 class="h6">Entretien / suivi</h3>
            <p class="mb-0">{{ plant["care_notes"] }}</p>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>

{# ---------------------------------------------------------
   Optionnel : rappel synthétique des infos d’espèce
---------------------------------------------------------- #}

{% if plant["species_morphology"] or plant["species_culture"] or plant["species_uses"] %}
  <div class="card shadow-soft mb-4">
    <div class="card-body small">
      <h2 class="h6 mb-2">Résumé botanique (espèce)</h2>

      <div class="row g-3">
        {% if plant["species_morphology"] %}
          <div class="col-md-4">
            <div class="fw-semibold mb-1">Morphologie</div>
            <p class="mb-0 text-muted">{{ plant["species_morphology"] }}</p>
          </div>
        {% endif %}

        {% if plant["species_culture"] %}
          <div class="col-md-4">
            <div class="fw-semibold mb-1">Culture</div>
            <p class="mb-0 text-muted">{{ plant["species_culture"] }}</p>
          </div>
        {% endif %}

        {% if plant["species_uses"] %}
          <div class="col-md-4">
            <div class="fw-semibold mb-1">Usages</div>
            <p class="mb-0 text-muted">{{ plant["species_uses"] }}</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}

{% block scripts_extra %}
  {{ super() }}
  <script>
  (function () {
    const prevId = {{ prev_id|default(None)|tojson }};
    const nextId = {{ next_id|default(None)|tojson }};

    if (prevId === null && nextId === null) {
      return;
    }

    let startX = null;
    let startY = null;
    const threshold = 40;   // un peu plus sensible (avant 60)
    const restraint = 80;   // plus tolérant en vertical (avant 40)

    // On n’écoute que sur le contenu principal, pas sur toute la page
    const zone = document.querySelector("main") || document;

    zone.addEventListener('touchstart', function (e) {
      if (!e.changedTouches || e.changedTouches.length === 0) return;
      const t = e.changedTouches[0];
      startX = t.clientX;
      startY = t.clientY;
    }, { passive: true });

    zone.addEventListener('touchend', function (e) {
      if (startX === null || !e.changedTouches || e.changedTouches.length === 0) return;

      const t = e.changedTouches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      // swipe horizontal dominant
      if (Math.abs(dx) > threshold && Math.abs(dy) < restraint) {
        // gauche → suivant
        if (dx < 0 && nextId !== null) {
          window.location.href = "/plant/" + nextId;
        }
        // droite → précédent
        else if (dx > 0 && prevId !== null) {
          window.location.href = "/plant/" + prevId;
        }
      }

      startX = null;
      startY = null;
    }, { passive: true });
  })();
  </script>
{% endblock %}

